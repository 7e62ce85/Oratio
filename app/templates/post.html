{% extends "layout.html" %}
{% block title %}{{post.title}} | {{config.LEMA}}{% endblock %}

{% block navbar %}
{{ super() }}
<li>
  <a href="{{url_for('sub.view_sub', sub=sub.name)}}" class="1">{{sub.name}}</a>
</li>
{% endblock %}

{% block sidebar %}
<div id="sortbuttons" role="group" class="pure-button-group">
  <div class="pure-g">
    <a href="{{url_for('sub.view_sub_hot', sub=sub.name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'sub.view_sub_hot' %}pure-button-primary{%endif%} pure-u-md-7-24">Hot</a>
    <a href="{{url_for('sub.view_sub_top', sub=sub.name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'sub.view_sub_top' %}pure-button-primary{%endif%} pure-u-md-7-24">Top</a>
    <a href="{{url_for('sub.view_sub_new', sub=sub.name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'sub.view_sub_new' %}pure-button-primary{%endif%} pure-u-md-7-24">New</a>
  </div>
</div>

<form class="pure-g search" action="{{ url_for('do.search') }}" method="post">
  <div class="icon" data-icon="search"> </div>
  <input name="term" placeholder="Title search..." type="search" class="pure-u-1">
</form>

<hr/>
<div class="author" style="padding:.5em;">
  Posted <time-ago datetime="{{post.posted.isoformat()}}Z"></time-ago> by
  {% if post.deleted == 0 %}
    {% if post.userstatus != 10 %}
    <a class="authorlink" namedata="{{post.user}}" href="{{url_for('view_user', user=post.user)}}">{{post.user}}</a>
    {%else%}
    <a class="authorlink deleted">[Deleted]</a>
    {%endif%}
  {% else %}
    <span class="deleted">[deleted]</span>
  {%endif%}
  <br/>
  {% if post.edited %}
    edited <time-ago datetime="{{post.edited.isoformat()}}Z"></time-ago><br/>
  {% endif %}
  Score: {{post.score}} <b>(+{{func.get_post_upcount(post.pid)}}|-{{func.get_post_downcount(post.pid)}})</b>
</div>
<hr/>
{% if current_user.is_authenticated %}
  {% if not (func.isRestricted(sub) and not current_user.is_mod(sub.sid)) %}
    {%if not current_user.is_subban(sub) %}
      <a href="{{url_for('submit', ptype='text', sub=sub.name)}}" class="sbm-post pure-button">Submit a text post</a>
      <a href="{{url_for('submit', ptype='link', sub=sub.name)}}" class="sbm-post pure-button">Submit a link post</a>
    {%endif%}
  {%endif%}
{%endif%}


<div class="subinfo">
  <h3><a href="{{url_for('sub.view_sub', sub=sub.name)}}">{{conf['SUB_PREFIX']}}/{{sub.name}}</a> {% if sub.nsfw %}<div class="nsfw" alt="Not safe for work">NSFW</div>{%endif%}</h3>
</div>
<div class="subs">{{getSuscriberCount(sub).subscribers}} subscribers</div>

<div role="group" class="pure-button-group" data-sid="{{sub.sid}}">
  {% if current_user.has_subscribed(sub.name) %}
    <button data-ac="unsubscribe" class="sub button-secondary pure-button button-xsmall pure-button-active"><span class="sbm-icon" data-icon="check"></span>Subscribed</button>
  {%else%}
    <button data-ac="subscribe" class="unsub button-secondary pure-button button-xsmall"><span class="sbm-icon" data-icon="add"></span>Subscribe</button>
  {%endif%}
  {% if current_user.has_blocked(sub.sid) %}
    <button data-ac="unblock" class="blk button-warning pure-button button-xsmall pure-button-active"><span class="sbm-icon" data-icon="check"></span>Blocked</button>
  {%else%}
    <button data-ac="block" class="unblk button-warning pure-button button-xsmall"><span class="sbm-icon" data-icon="close"></span>Block</button>
  {%endif%}
</div>
<hr>
{%if sub.sidebar != ''%}
  {{markdown(sub.sidebar)|safe}}
  <hr>
{%endif%}

<div class="moderators">
  Moderators
  <ul>
  <li><span title="Owner" class="i-icon" data-icon="owner"></span> <a href="{{url_for('view_user', user=func.getSubUsers(sub, 'mod1'))}}">{{func.getSubUsers(sub, 'mod1')}}</a></li>
  {% for mod in mods %}
  <li><a href="{{url_for('view_user', user=db.get_user_from_uid(mod.value).name)}}">{{db.get_user_from_uid(mod.value).name}}</a></li>
  {% endfor %}
  </ul>
</div>

<div class="createdby">
  Created by {{func.getSubUsers(func.getSub(sub.sid), 'mod')}}
  <time-ago datetime="{{func.getSubCreation(sub)}}Z"></time-ago>
</div>

{% if current_user.is_mod(post.sid) or current_user.is_admin() %}
  <a href="{{url_for('sub.edit_sub', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Info</a>
  <a href="{{url_for('sub.edit_sub_flairs', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Flairs</a>
  <a href="{{url_for('sub.edit_sub_css', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Stylesheet</a>
  <a href="{{url_for('sub.edit_sub_mods', sub=sub.name)}}" class="sbm-post pure-button">Moderators</a>
{% endif %}
<hr>

<a href="{{url_for('sub.view_sublog', sub=sub.name)}}" class="sbm-post pure-button">Sub Log</a>
<a href="{{url_for('sub.view_sub_bans', sub=sub.name)}}" class="sbm-post pure-button">Banned Users</a>
{% endblock %}

{% block main %}
<div class="wholepost">
  <div class="postbar post" pid="{{post.pid}}">
    <div class="misctainer">
      <div class="votebuttons">
        {% if post.userstatus != 10 and (datetime.datetime.utcnow() - post.posted) < datetime.timedelta(days=60) %}
        <div title="Upvote" class="upvote{%if post.positive == 1%} upvoted{%endif%}" data-pid="{{post.pid}}" data-icon="upvote"></div>
        <div class="score">{{post.score}}</div>
        <div title="Downvote" class="downvote{%if post.positive == 0%} downvoted{%endif%}" data-pid="{{post.pid}}" data-icon="downvote"></div>
        {%endif%}
      </div>
      <div class="thcontainer">
        <a href="{{url_for('sub.view_post', sub=sub.name, pid=post.pid)}}" class="title">
          <div class="thumbnail">
            {% if post.thumbnail != '' and post.link != None %}
              <img src="{{config.THUMBNAIL_HOST}}{{post.thumbnail}}"/>
            {% elif post.link != None %}
              <span class="placeholder" data-icon="link"></span>
            {%else%}
              <span class="placeholder" data-icon="chat"></span>
            {% endif%}

          </div>
        </a>
      </div>
    </div>

    <div class="postinfo">
      <div class="post-heading">
        {% if post.nsfw or sub.nsfw %}
        <div class="nsfw" alt="Not safe for work">NSFW</div>
        {%endif%}
        {% if func.getPostFlair(post) %}<span class="postflair">{{func.getPostFlair(post)}}</span>{% endif %}
        {% if post.link == None %}
          <a href="{{url_for('sub.view_post', sub=sub.name, pid=post.pid)}}" class="title">{{post.title}}</a>
        {% else %}
          <a href="{% if post.deleted == 0%}{{post.link}}{%else%}#{%endif%}" class="title">{{post.title}}</a> {%if post.deleted == 0%}<a href="{{url_for('all_domain_new', domain=func.getDomain(post.link), page=1)}}" class="domain">({{func.getDomain(post.link)}})</a>{%endif%}
        {% endif %}
      </div>
      <ul class="links" data-pid="{{post.pid}}">
        {% if post.link %}
          {% if func.getDomain(post.link) in ('youtube.com', 'www.youtube.com', 'youtu.be', 'gfycat.com', 'vimeo.com', 'vine.co', 'hooktube.com', 'www.hooktube.com', 'instaud.io') %}
          <li><div class="expando" data-pid="{{post.pid}}" data-t="lnk" data-link="{{post.link}}"><div class="icon expando-btn" data-icon="play"></div></div></li>
          {% elif func.isImage(post.link) %}
          <li><div class="expando" data-pid="{{post.pid}}" data-t="lnk" data-link="{{post.link}}"><div class="icon expando-btn" data-icon="image"></div></div></li>
          {% elif func.isVideo(post.link) or func.isGifv(post.link) %}
          <li><div class="expando" data-pid="{{post.pid}}" data-t="lnk" data-link="{{post.link}}"><div class="icon expando-btn" data-icon="play"></div></div></li>
          {% endif %}
        {% endif %}
          {% if current_user.is_authenticated and post.deleted == 0 %}
           <li><a class="post-source">source</a></li>
            {% if db.get_user_saved(current_user.uid, post.pid) %}
              <li><a class="removesavedpost" data-pid="{{post.pid}}">unsave</a></li>
            {% else %}
              <li><a class="savepost" data-pid="{{post.pid}}">save</a></li>
            {% endif %}
            {% if (func.userCanFlair(func.getSub(post.sid)) and current_user.uid == post.uid) or current_user.is_mod(post.sid) %}
              <li><a class="editflair">flair</a></li>
            {% endif %}
            {% if post.uid == current_user.uid %}
              <li><a class="edit-post" data-pid="{{post.pid}}">edit</a></li>
              {% if (datetime.datetime.utcnow() - post.posted) < datetime.timedelta(seconds=300) %}
                <li><a class="edit-title" data-pid="{{post.pid}}">edit title</a></li>
              {% endif %}
            {% endif %}
            {% if post.uid == current_user.uid or current_user.is_admin() or current_user.is_mod(post.sid) %}
              <li id="delpostli"><a {% if post.uid == current_user.uid %}selfdel="true"{%endif%} class="delete-post"> delete </a></li>
            {%endif%}
            {% if not sub.nsfw and (post.uid == current_user.uid or current_user.is_admin() or current_user.is_mod(post.sid)) %}
             {% if not post.nsfw %}
              <li><a class="nsfw-post"> tag as nsfw </a></li>
             {% else %}
              <li><a class="nsfw-post"> remove nsfw </a></li>
             {% endif %}
            {%endif%}
            <!-- Note from past self: DO NOT REMOVE THIS UNLESS YOU'VE FINISHED UNFUCKING THE JS -->
            <form id="delete-post-form" class="hide">{{delpostform.csrf_token}}{{delpostform.post(value=post.pid)}}{{delpostform.reason}}</form>
            {% if current_user.is_mod(post.sid) %}
              {% if post.pid in func.getStickyPid(post['sid']) %}
                <li><a class="stick-post">unstick</a></li>
              {% else %}
                <li><a class="stick-post">make sticky</a></li>
              {% endif %}
            {%endif%}
            {% if post.sub.lower() == "announcements" and current_user.is_admin %}
             {% if not func.getAnnouncement() or func.getAnnouncement().pid != post['pid'] %}
               <li><a class="announce-post">make announcement</a></li>
             {%endif%}
            {% endif %}
          {%endif%}
        </ul>
    </div>
  </div>
  {% if (func.userCanFlair(func.getSub(post.sid)) and current_user.uid == post.uid) or current_user.is_mod(post.sid) %}
    <div style="display:none;" id="postflairs">
      <span class="closemsg">×</span>
      {% if func.getPostFlair(post) %}
      <div>Current flair: <span class="postflair">{{func.getPostFlair(post)}}</span>. <a data-sub="{{post.sub}}" data-pid="{{post.pid}}" href="#" id="remove-flair">Remove</a>.</div>
      {%endif%}
      <h4>Select a new flair</h4>
      {% for ll in editpostflair.flair %}
        <span class="selflair" data-sub="{{post.sub}}" data-flair="{{ll.data}}" data-pid="{{post.pid}}">{{ll.label}}</span>
      {% endfor %}
    </div>
  {%endif %}
  {% if post.deleted == 0 and post.ptype == 3%}
    <div class="poll-space">
      {% if not poll_open %}
      <p>This poll is now <b>closed</b>.</p>
      {% elif not has_voted %}
        {% if ('hide_results' in postmeta and not poll_open) or ('hide_results' not in postmeta) %}
        <p><button id="poll-show-results" type="button" class="pure-button">Show results.</button></p>
        {%endif%}
      {%endif%}
      {%for opt in poll_options %}
        
        <div class="poll-option" data-oid="{{opt.id}}">
          {%if opt.id == voted_for %}<b>{{opt.text}} (voted)</b>{%else%}{{opt.text}}{%endif%}
          
          <div class="poll-bar">
            <div class="poll-vote">
              {% if not has_voted and current_user.is_authenticated and poll_open %}
              <form method="POST" action="{{url_for('do.cast_vote', pid=post.pid, oid=opt.id)}}">
                {{delpostform.csrf_token}} {# Stolen csrf token >_> #}
                <button type="submit" class="poll-vote-btn pure-button button-xsmall button-secondary" data-oid="{{opt.id}}">Vote</button>
              </form>
              {% endif %}
            </div>
            {% if ('hide_results' in postmeta and not poll_open) or ('hide_results' not in postmeta) %}
              <div class="poll-hid poll-pbar {%if opt.id == voted_for %}poll-voted{%endif%}" style="{% if not has_voted and poll_open %}display:none;{%endif%}">
                <div style="width:{% if votes != 0 %}{{(opt.votecount/votes*100)|round}}{%else%}0{%endif%}%"></div>
              </div>
              <div class="poll-hid poll-votes"  style="{% if not has_voted and poll_open %}display:none;{%endif%}">
                  <span class="percentage-number">{% if votes != 0 %}{{(opt.votecount/votes*100)|round|int}}{%else%}0{%endif%}</span>% ({{opt.votecount}} votes)
              </div>
            {%endif%}
          </div>
        </div>
      {% endfor %}
      {% if has_voted and current_user.is_authenticated and poll_open %}
        <form method="POST" action="{{url_for('do.remove_vote', pid=post.pid)}}">
          {{delpostform.csrf_token}}
          <button type="submit" class="poll-vote-btn pure-button button-secondary">Withdraw vote</button>
        </form>
      {%endif %}
    </div>
  {%endif%}
   {% if post.content %}
     {% if post.deleted == 0 %}
       <div id="postcontent">
         {{markdown(post.content)|safe}}
       </div>
       <div id="post-source">{{post.content}}</div>
     {%else%}
      <div class="deleted">[deleted]</div>
     {%endif%}
   {% elif not post.link %}
    <div id="postcontent"></div>
    <div id="post-source"></div>
   {%endif%}

   {%if current_user.is_authenticated and post.deleted == 0 %}
     <form data-reset="true" data-redir="true" action="{{url_for('do.create_comment', pid=post.pid)}}" class="comment-form ajaxform static pure-form">
       {{commentform.csrf_token}}
       {{commentform.post(value=post.pid)}}
       {{commentform.parent(value='0')}}
       <div class="markdown-editor" id="ncme">
         {{commentform.comment(id="comment2", placeholder="Write your comment here. Styling with Markdown format is supported.", rows="6")}}
       </div>
       <div class="div-error error alertbox"></div>
       <button type="submit" class="pure-button pure-button-primary">Submit comment</button>
       <button data-pvid="ncme" class="pure-button btn-preview">Preview</button>
       <div class="cmpreview canclose" style="display:none;">
         <h4>Comment preview</h4>
         <span class="closemsg">×</span>
         <div class="cpreview-content"></div>
       </div>
     </form>
   {%endif%}

   {% if comments|length == 0 %}
    <div class="comments"><h3 id="cmnts">No comments yet...</h3></div>
   {%else%}
    <div class="comments">
      <h2 id="cmnts"><a href="{{url_for('sub.view_post', sub=sub.name, pid=post.pid)}}">{{ncomments}} comments</a></h2>
      {% include "postcomments.html" %}
    </div>
   {%endif%}
</div>

{% endblock %}
{%block pagefoot%}
{% if not current_user.block_styles() %}
<style>{{db.get_sub_stylesheet(post.sid)|safe}}</style>
{% endif %}
{%endblock%}
