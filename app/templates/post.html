{% extends "layout.html" %}
{% block title %}{{post.title}} | Throat: Open discussion{% endblock %}

{% block navbar %}
<ul class="right">
  <li class="large"><a href="{{url_for('view_sub', sub=post.sub.name)}}">/s/{{post.sub.name}}</a></li>
</ul>
{% endblock %}
{% block sidebar %}
{{ super() }}<hr/>

{# temp #}
<p>
    /s/{{post.sub.name}}
  <br>
    {{post.sub.title}}
</p>

<div class="row buttons">
  <div class="col-12">
    <a href="#post-form" class="btn btn-blue create-post" style="width:100%;">Submit a text post</a>
  </div>
  <div class="col-12">
    <a href="#link-post-form" class="btn btn-blue create-post" style="width:100%;">Submit a link post</a>
  </div>
  {% if current_user.is_mod(post.sub) %}
  <div class="col-12">
    <a href="#edit-sub-form" class="btn btn-blue edit-sub" style="width:100%;">Edit Sub Info</a>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block main %}
    <main class="col-8 right">
        <article class="text-post center no-padding">
          <div class="head">
            <h1 class="title">{{post.title}}</h1>
            <div class="info">
            {# if post.ptype == 1 %}
              <p class="modpost"><i class="fa fa-user fa-2x" aria-hidden="true"></i> Mod post</p>
            {% endif #}
              <a href="{{url_for('view_user', user=post.user.name)}}" class="btn small"><i class="fa fa-user" aria-hidden="true"></i> {{post.user.name}}</a>
              <span class="time btn small">
                <i class="fa fa-clock-o" aria-hidden="true"></i> Posted <time-ago datetime="{{post.posted.isoformat()}}"></time-ago>
              </span>
            {% if post.edited == true %}
              <span class="time btn small">
                <i class="fa fa-clock-o" aria-hidden="true"></i> Last edited <time-ago datetime="{{post.posted.isoformat()}}"></time-ago>
              </span>
            {% endif %}
            {% if post.ptype == 0 and post.user.uid == session['user_id'] %}
              <a href="#edit-txtpost-form" class="btn btn-blue edit small edit-txtpost-form"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit </a>
              <a href="#delete-txtpost-form" class="btn btn-blue edit small delete-txtpost-form"><i class="fa fa-times-circle" aria-hidden="true"></i> Delete </a>
            {% endif %}
            </div>
          </div>
          {% if post.ptype == 0 %}
          <div class="content">{{markdown(post.content)|safe}}</div>
          {% else %}
          <div class="content"><a href="{{post.link}}" target="_blank" rel="noreferrer noopener">{{post.link}}</a>
          {% if domain == "youtube.com" %}
            <span id="youtubevid" data-vid="{{post.link}}" data-pid="{{post.pid}}" class="closedvid">
              <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-youtube-play" aria-hidden="true"></i></a></span>
            </span>
          {% endif %}
          {% if post.link.endswith('.png') or post.link.endswith('.gif') or post.link.endswith('.jpg') %}
            <span id="openimg" data-img="{{post.link}}" data-pid="{{post.pid}}" class="closedimg">
              <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-image" aria-hidden="true"></i></a></span>
            </span>
          {% endif %}
          </div>
          {% endif %}
        </article>
        {%if current_user.is_authenticated %}
        <section id="postcomment">
          <form class="comment-form">
            {{commentform.csrf_token}}
            {{commentform.sub(value=post.sub.name)}}
            {{commentform.post(value=post.pid)}}
            {{commentform.parent(value='0')}}
            <div class="CommentContent">{{commentform.comment(placeholder="Write your comment here. Styling with Markdown format is supported.")}}</div>
            <button type="submit" class="btn btn-blue">Submit comment</button>
          </form>
          <form class="comment-form moving" style="display:none">
            <div class="close">Ã—</div>
            {{commentform.csrf_token}}
            {{commentform.sub(value=post.sub.name)}}
            {{commentform.post(value=post.pid)}}
            {{commentform.parent(value='0')}}
            <div class="CommentContent">{{commentform.comment(class="commenttxtbox",placeholder="Write your comment here. Styling with Markdown format is supported.")}}</div>
            <button type="submit" class="btn btn-blue">Submit comment</button>
          </form>
        </section>
        {%endif%}
        <section id="comments">
          <h1>Comments</h1>
          {% if post.comments.count() < 1 %}
          <p>
            Be the first to comment this post
          </p>
          {% endif %}
          {% for comment in post.comments recursive %}
            {% if (loop.depth == 1 and not comment.parentcid) or loop.depth >1 %}
            <article data-cid="{{comment.cid}}" class="text-post center no-padding comment sub-{{loop.depth0}}">
              <div class="head">
                <div class="info">
                {# if post.ptype == 1 %}
                  <p class="modpost"><i class="fa fa-user fa-2x" aria-hidden="true"></i> Mod post</p>
                {% endif #}
                  <a href="{{url_for('view_user', user=comment.user.name)}}" class="btn small"><i class="fa fa-user" aria-hidden="true"></i> {{comment.user.name}}</a>
                  <span class="time btn small">
                    <i class="fa fa-clock-o" aria-hidden="true"></i> Posted <time-ago datetime="{{comment.time.isoformat()}}"></time-ago>
                  </span>
                {# if post.edited == true
                  <span class="time btn small">
                    <i class="fa fa-clock-o" aria-hidden="true"></i> Last edited <time-ago datetime="{{comment.time.isoformat()}}"></time-ago>
                  </span>
                {% endif #}
                {% if comment.uid == session['user_id'] %}
                  <a href="#edit-comment-form" class="btn btn-blue edit small edit-comment-form"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit </a>
                  <a href="#delete-comment-form" class="btn btn-blue edit small delete-comment-form"><i class="fa fa-times-circle" aria-hidden="true"></i> Delete </a>
                {% endif %}
                </div>
              </div>
              <div class="content">{{markdown(comment.content)|safe}}</div>
              {%if current_user.is_authenticated%}
              <span class="bottombar btn small">
                <a href="#reply" class="lnkreply" data-to="{{comment.cid}}">
                  <i class="fa fa-reply" aria-hidden="true"></i> reply
                </a>
              </span>
              {%endif%}
            </article>
            {% if comment.children %}
              {{loop(comment.children)}}
            {%endif%}
            {%endif%}
          {%endfor%}
        </section>
    </main>

  {% if post.ptype == 0 and post.user.uid == session['user_id'] %}
  <form id="edit-txtpost-form" data-sub="{{post.sub.name}}" data-pid="{{post.pid}}" class="mfp-hide white-popup-block">
    {{edittxtpostform.csrf_token}}
    <h1>Edit your text post</h1>
    <p class="content">{{edittxtpostform.content(placeholder="Write your post content here. Styling with Markdown format is supported.")}}</p>
    <div class="alert div-error">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <p></p>
    </div>
    <p><button type="submit" id="edit-txpost-btnsubmit">Edit post</button></p>
  </form>
  {% endif %}

{% endblock %}
{%block pagefoot%}
{%if current_user.is_authenticated%}
<script type="text/javascript" src="{{ url_for('static', filename='js/simplemde.min.js') }}"></script>
<script>
  var simplemde = new SimpleMDE({autoDownloadFontAwesome: false, spellChecker: false, autosave: {enabled: true, unique_id: "createcomment",}});
  var simplemde2 = new SimpleMDE({autoDownloadFontAwesome: false, spellChecker: false, autosave: {enabled: false}, element: $('#edit-txtpost-form textarea#content')[0]});
</script>
{%endif%}
{%endblock%}
