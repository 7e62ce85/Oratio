{% extends "layout.html" %}
{% block title %}{{post.title}} | {{config.LEMA}}{% endblock %}

{% block navbar %}
<li>
  <a href="{{url_for('view_sub', sub=func.getSub(post.sid).name)}}">
    {% if func.isNSFW(func.getSub(post.sid)) %}
      <span class="bgred" alt="Not safe for work">NSFW</span>
    {% endif %}
    {{func.getSub(post.sid).name}}
  </a>
</li>
<li><a href="{{url_for('view_sub_hot', sub=func.getSub(post.sid).name)}}">Hot</a></li>
<li><a href="{{url_for('view_sub_top', sub=func.getSub(post.sid).name)}}">Top</a></li>
<li><a href="{{url_for('view_sub_new', sub=func.getSub(post.sid).name)}}">New</a></li>
{% endblock %}
{% block sidebar %}
<div id="sortbuttons" role="group" class="pure-button-group">
  <div class="pure-g">
    <a href="{{url_for('view_sub_hot', sub=func.getSub(post.sid).name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'view_sub_hot' %}pure-button-primary{%endif%} pure-u-md-7-24">Hot</a>
    <a href="{{url_for('view_sub_top', sub=func.getSub(post.sid).name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'view_sub_top' %}pure-button-primary{%endif%} pure-u-md-7-24">Top</a>
    <a href="{{url_for('view_sub_new', sub=func.getSub(post.sid).name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'view_sub_new' %}pure-button-primary{%endif%} pure-u-md-7-24">New</a>
  </div>
</div>

<form class="pure-g search" action="{{ url_for('do.title_search') }}" method="post">
  <div class="icon" data-icon="search"> </div>
  <input name="term" placeholder="Title search..." type="search" class="pure-u-1">
</form>
<hr/>

<div class="subinfo">
  <h3>/s/{{sub.name}} {% if sub.nsfw %}<div class="nsfw" alt="Not safe for work">NSFW</div>{%endif%}</h3>
</div>
<div class="subs">{{getSuscriberCount(sub)}} subscribers</div>

<div role="group" class="pure-button-group">
  {% if current_user.has_subscribed(sub.sid) %}
    <button class="button-secondary pure-button button-xsmall pure-button-active"><span class="sbm-icon" data-icon="check"></span>Subscribed</button>
  {%else%}
    <button class="button-secondary pure-button button-xsmall"><span class="sbm-icon" data-icon="add"></span>Subscribe</button>
  {%endif%}
  {% if current_user.has_blocked(sub.sid) %}
    <button class="button-warning pure-button button-xsmal pure-button-activel"><span class="sbm-icon" data-icon="check"></span>Blocked</button>
  {%else%}
    <button class="button-warning pure-button button-xsmall"><span class="sbm-icon" data-icon="close"></span>Block</button>
  {%endif%}
</div>
<hr>
{%if sub.sidebar != ''%}
  {{markdown(sub.sidebar)|safe}}
  <hr>
{%endif%}

<div class="moderators">
  Moderators
  <ul>
  <li><span title="Owner" class="i-icon" data-icon="owner"></span> <a href="{{url_for('view_user', user=func.getSubUsers(sub, 'mod1'))}}">{{func.getSubUsers(sub, 'mod1')}}</a></li>
  {% for mod in mods %}
  <li><a href="{{url_for('view_user', user=db.get_user_from_uid(mod.value).name)}}">{{db.get_user_from_uid(mod.value).name}}</a></li>
  {% endfor %}
  </ul>
</div>

<div class="createdby">
  Created by {{func.getSubUsers(func.getSub(sub.sid), 'mod')}}
  <time-ago datetime="{{func.getSubCreation(sub)}}Z"></time-ago>
</div>

{% if current_user.is_mod(sub) or current_user.is_admin() %}
  <a href="{{url_for('edit_sub', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Info</a>
  <a href="{{url_for('edit_sub_flairs', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Flairs</a>
  <a href="{{url_for('edit_sub_css', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Stylesheet</a>
  <a href="{{url_for('edit_sub_mods', sub=sub.name)}}" class="sbm-post pure-button">Moderators</a>
{% endif %}
<hr>

<a href="{{url_for('view_sublog', sub=sub.name)}}" class="sbm-post pure-button">Sub Log</a>
<a href="{{url_for('view_sub_bans', sub=sub.name)}}" class="sbm-post pure-button">Banned Users</a>

{% endblock %}

{% block main %}
<div class="wholepost">
  <div class="pure-g">
    <div class="misctainer pure-u-3-24">
      <div class="votebuttons">
        <div title="Upvote" class="upvote{%if post.positive == 1%} upvoted{%endif%}" data-pid="{{post.pid}}" data-icon="upvote"></div>
        <div class="score">{{post.score}}</div>
        <div title="Downvote" class="downvote{%if post.positive == 0%} downvoted{%endif%}" data-pid="{{post.pid}}" data-icon="downvote"></div>
      </div>
      <div class="thcontainer">
        <a href="{{url_for('view_post', sub=post.sub, pid=post.pid)}}" class="title">
          <div class="thumbnail">
            {% if post.thumbnail != '' and post.link != None %}
              <img src="{{config.THUMBNAIL_HOST}}{{post.thumbnail}}"/>
            {% elif post.link != None %}
              <span class="placeholder" data-icon="link"></span>
            {%else%}
              <span class="placeholder" data-icon="chat"></span>
            {% endif%}

          </div>
        </a>
      </div>
    </div>
    <div class="pure-u-21-24">
      <div class="post-heading">
        {% if post.nsfw %}
        <div class="nsfw" alt="Not safe for work">NSFW</div>
        {%endif%}
        {% if func.getPostFlair(post) %}<span class="flair">{{func.getPostFlair(post)}}</span>{% endif %}
        {% if post.link == None %}
          <a href="{{url_for('view_post', sub=post.sub, pid=post.pid)}}" class="title">{{post.title}}</a>
        {% else %}
          <a href="{{post.link}}" class="title">{{post.title}}</a> <a href="{{url_for('all_domain_new', domain=func.getDomain(post.link), page=1)}}" class="domain">({{func.getDomain(post.link)}})</a>
        {% endif %}
      </div>
      <div class="author">
        posted <time-ago datetime="{{post.posted.isoformat()}}Z"></time-ago> by
        {% if not db.is_post_deleted(post) %}
          <a href="{{url_for('view_user', user=func.getUser(post.uid).name)}}">{{func.getUser(post.uid).name}}</a>
        {% else %}
          <span class="deleted">[deleted]</span>
        {%endif%}
       </div>
       <ul class="links" data-pid="{{post.pid}}">
         {% if current_user.is_authenticated and not db.is_post_deleted(post) %}
          <li><a class="post-source">source</a></li>

           {% if db.get_user_saved(current_user.uid, post.pid) %}
             <li><a class="removesavedpost" data-pid="{{post.pid}}">unsave</a></li>
           {% else %}
             <li><a class="savepost" data-pid="{{post.pid}}">save</a></li>
           {% endif %}
           {% if func.userCanFlair(func.getSub(post.sid)) or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
             <li><a class="editflair">flair</a></li>
           {% endif %}
           {% if func.getUser(post.uid).uid == session['user_id'] %}
             <li><a class="edit-post">edit</a></li>
           {% endif %}
           {% if func.getUser(post.uid).uid == session['user_id'] or current_user.is_admin() %}
             <li><a class="delete-post"> delete </a></li>
           {%endif%}
           <form id="delete-post-form" class="hide">{{delpostform.csrf_token}}{{delpostform.post(value=post.pid)}}</form>
           {% if current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
             {% if post in func.getStickies(post['sid']) %}
               <li><a class="stick-post">unstick</a></li>
             {% else %}
               <li><a class="stick-post">make sticky</a></li>
             {% endif %}
           {%endif%}
         {%endif%}
       </ul>

    </div>
  </div>
   {% if post.content %}
   {% if not db.is_post_deleted(post) %}
     <div id="postcontent">
       {{markdown(post.content)|safe}}
     </div>
     <div id="post-source">{{post.content}}</div>
   {%else%}
    <div class="deleted">[deleted]</div>
   {%endif%}
   {%endif%}

   {%if current_user.is_authenticated %}
     <form data-reset="true" data-reload='true' action="{{url_for('do.create_comment', sub=func.getSub(post.sid).name, pid=post.pid)}}" class="comment-form ajaxform static pure-form">
       {{commentform.csrf_token}}
       {{commentform.sub(value=func.getSub(post.sid).name)}}
       {{commentform.post(value=post.pid)}}
       {{commentform.parent(value='0')}}
       <div class="markdown-editor">
         {{commentform.comment(id="comment2", placeholder="Write your comment here. Styling with Markdown format is supported.", rows="6")}}
       </div>
       <div class="error alertbox"></div>
       <button type="submit" class="pure-button pure-button-primary">Submit comment</button>
     </form>
     <form data-reset="true" data-reload='true'  method="POST" action="{{url_for('do.create_comment', sub=func.getSub(post.sid).name, pid=post.pid)}}" class="ajaxform comment-form moving" style="display:none">
       <span class="close">Ã—</span>
       {{commentform.csrf_token}}
       {{commentform.sub(value=func.getSub(post.sid).name)}}
       {{commentform.post(value=post.pid)}}
       {{commentform.parent(value='0')}}
       {{commentform.comment(class="commenttxtbox",placeholder="Write your comment here. Styling with Markdown format is supported.", rows="6")}}
       <div class="alertbox error"></div>
       <button type="submit" class="btn btn-orange">Submit comment</button>
     </form>

   {%endif%}

   {% if comments|length == 0 %}
    <div class="comments"><h3>No comments yet...</h3></div>
   {%else%}
    <div class="comments">
      <h3>{{comments|length}} comments</h3>
      {% include "postcomments.html" %}
    </div>
   {%endif%}
</div>




  {% if current_user.is_authenticated %}
    <form action="{{url_for('do.edit_comment')}}" data-reload="true" id="edit-comment-form"  method="POST" class="ajaxform hide white-popup-block">
      <h2>Edit comment</h2>
      {% set cf = form.EditCommentForm() %}
      {{cf.csrf_token}}{{cf.cid(id="ecf-cid")}}
      <p>{{cf.text(rows="10", **{'data-provide' :"markdown"})}}</p>
      <p><button type="submit" class="btn btn-blue" data-prog="Saving..">Edit comment</button></p>
    </form>

    <form action="{{url_for('do.delete_comment')}}" id="delete-comment-form"  method="POST" class="ajaxform hide white-popup-block">
      {% set cf = form.DeleteCommentForm() %}
      {{cf.csrf_token}}{{cf.cid(id="dcf-cid")}}
    </form>
  {%endif%}
  {% if func.getUser(post.uid).uid == session['user_id'] or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
  <form id="edit-flair-form" class="hide white-popup-block ajaxform" action="" method="POST">
    {{editpostflair.csrf_token}}
    {{editpostflair.post(value=post.pid)}}
    {% if func.getPostFlair(post) %}
    <h3>Current flair</h3>
    <p><div class="btn">{{func.getPostFlair(post)}}</div></p>
    <p><div class="btn btn-blue" id="removepostflair" data-sub="{{func.getSub(post.sid).name}}" data-post="{{post.pid}}"><i class="fa fa-remove"></i> Remove current flair</div></p>

    {% endif %}
    <h3>Avalable post flairs</h3>
    <div class="btn-group" data-toggle="buttons">
      {% for ll in editpostflair.flair %}
        <label class="btn btn-default assignpostflair" data-fl="{{ll.data}}" data-sub="{{func.getSub(post.sid).name}}" data-post="{{post.pid}}">
          {{ll}}
          {{ll.label}}</label>
      {%endfor %}
    </div>

  </form>
  {% endif %}

{% endblock %}
{%block pagefoot%}
{% if not current_user.block_styles() %}
<style>{{db.get_sub_stylesheet(post.sid)|safe}}</style>
{% endif %}
{%endblock%}
