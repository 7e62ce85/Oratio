{% extends "layout.html" %}
{% block title %}{{post.title}} | {{config.LEMA}}{% endblock %}

{% block navbar %}
{{ super() }}
<li>
  <a href="{{url_for('view_sub', sub=sub.name)}}" class="1">{{sub.name}}</a>
</li>
{% endblock %}

{% block sidebar %}
<div id="sortbuttons" role="group" class="pure-button-group">
  <div class="pure-g">
    <a href="{{url_for('view_sub_hot', sub=sub.name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'view_sub_hot' %}pure-button-primary{%endif%} pure-u-md-7-24">Hot</a>
    <a href="{{url_for('view_sub_top', sub=sub.name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'view_sub_top' %}pure-button-primary{%endif%} pure-u-md-7-24">Top</a>
    <a href="{{url_for('view_sub_new', sub=sub.name)}}" class="sbm-post pure-button button-xsmall {% if request.endpoint == 'view_sub_new' %}pure-button-primary{%endif%} pure-u-md-7-24">New</a>
  </div>
</div>

<form class="pure-g search" action="{{ url_for('do.title_search') }}" method="post">
  <div class="icon" data-icon="search"> </div>
  <input name="term" placeholder="Title search..." type="search" class="pure-u-1">
</form>
<hr/>

<div class="subinfo">
  <h3><a href="{{url_for('view_sub', sub=sub.name)}}">/s/{{sub.name}}</a> {% if sub.nsfw %}<div class="nsfw" alt="Not safe for work">NSFW</div>{%endif%}</h3>
</div>
<div class="subs">{{getSuscriberCount(sub)}} subscribers</div>

<div role="group" class="pure-button-group" data-sid="{{sub.sid}}">
  {% if current_user.has_subscribed(sub.name) %}
    <button data-ac="unsubscribe" class="sub button-secondary pure-button button-xsmall pure-button-active"><span class="sbm-icon" data-icon="check"></span>Subscribed</button>
  {%else%}
    <button data-ac="subscribe" class="unsub button-secondary pure-button button-xsmall"><span class="sbm-icon" data-icon="add"></span>Subscribe</button>
  {%endif%}
  {% if current_user.has_blocked(sub.sid) %}
    <button data-ac="unblock" class="blk button-warning pure-button button-xsmall pure-button-active"><span class="sbm-icon" data-icon="check"></span>Blocked</button>
  {%else%}
    <button data-ac="block" class="unblk button-warning pure-button button-xsmall"><span class="sbm-icon" data-icon="close"></span>Block</button>
  {%endif%}
</div>
<hr>
{%if sub.sidebar != ''%}
  {{markdown(sub.sidebar)|safe}}
  <hr>
{%endif%}

<div class="moderators">
  Moderators
  <ul>
  <li><span title="Owner" class="i-icon" data-icon="owner"></span> <a href="{{url_for('view_user', user=func.getSubUsers(sub, 'mod1'))}}">{{func.getSubUsers(sub, 'mod1')}}</a></li>
  {% for mod in mods %}
  <li><a href="{{url_for('view_user', user=db.get_user_from_uid(mod.value).name)}}">{{db.get_user_from_uid(mod.value).name}}</a></li>
  {% endfor %}
  </ul>
</div>

<div class="createdby">
  Created by {{func.getSubUsers(func.getSub(sub.sid), 'mod')}}
  <time-ago datetime="{{func.getSubCreation(sub)}}Z"></time-ago>
</div>

{% if current_user.is_mod(post.sid) or current_user.is_admin() %}
  <a href="{{url_for('edit_sub', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Info</a>
  <a href="{{url_for('edit_sub_flairs', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Flairs</a>
  <a href="{{url_for('edit_sub_css', sub=sub.name)}}" class="sbm-post pure-button">Edit Sub Stylesheet</a>
  <a href="{{url_for('edit_sub_mods', sub=sub.name)}}" class="sbm-post pure-button">Moderators</a>
{% endif %}
<hr>

<a href="{{url_for('view_sublog', sub=sub.name)}}" class="sbm-post pure-button">Sub Log</a>
<a href="{{url_for('view_sub_bans', sub=sub.name)}}" class="sbm-post pure-button">Banned Users</a>
{% endblock %}

{% block main %}
<div class="wholepost">
  <div class="pure-g postbar">
    <div class="misctainer pure-u-md-3-24 pure-u-2-24">
      <div class="votebuttons">
        <div title="Upvote" class="upvote{%if post.positive == 1%} upvoted{%endif%}" data-pid="{{post.pid}}" data-icon="upvote"></div>
        <div class="score">{{post.score}}</div>
        <div title="Downvote" class="downvote{%if post.positive == 0%} downvoted{%endif%}" data-pid="{{post.pid}}" data-icon="downvote"></div>
      </div>
      <div class="thcontainer">
        <a href="{{url_for('view_post', sub=sub.name, pid=post.pid)}}" class="title">
          <div class="thumbnail">
            {% if post.thumbnail != '' and post.link != None %}
              <img src="{{config.THUMBNAIL_HOST}}{{post.thumbnail}}"/>
            {% elif post.link != None %}
              <span class="placeholder" data-icon="link"></span>
            {%else%}
              <span class="placeholder" data-icon="chat"></span>
            {% endif%}

          </div>
        </a>
      </div>
    </div>

    <div class="postinfo pure-u-md-21-24 pure-u-22-24">
      <div class="post-heading">
        {% if post.nsfw or sub.nsfw %}
        <div class="nsfw" alt="Not safe for work">NSFW</div>
        {%endif%}
        {% if func.getPostFlair(post) %}<span class="postflair">{{func.getPostFlair(post)}}</span>{% endif %}
        {% if post.link == None %}
          <a href="{{url_for('view_post', sub=sub.name, pid=post.pid)}}" class="title">{{post.title}}</a>
        {% else %}
          <a href="{{post.link}}" class="title">{{post.title}}</a> <a href="{{url_for('all_domain_new', domain=func.getDomain(post.link), page=1)}}" class="domain">({{func.getDomain(post.link)}})</a>
        {% endif %}
      </div>
      <div class="author">
        posted <time-ago datetime="{{post.posted.isoformat()}}Z"></time-ago> by
        {% if not post.deleted %}
          <a class="authorlink" namedata="{{post.user}}" href="{{url_for('view_user', user=post.user)}}">{{post.user}}</a>
        {% else %}
          <span class="deleted">[deleted]</span>
        {%endif%}
       </div>
       <ul class="links" data-pid="{{post.pid}}">
         {% if current_user.is_authenticated and not post.deleted %}
          <li><a class="post-source">source</a></li>

           {% if db.get_user_saved(current_user.uid, post.pid) %}
             <li><a class="removesavedpost" data-pid="{{post.pid}}">unsave</a></li>
           {% else %}
             <li><a class="savepost" data-pid="{{post.pid}}">save</a></li>
           {% endif %}
           {% if (func.userCanFlair(func.getSub(post.sid)) and current_user.uid == post.uid) or current_user.is_mod(post.sid) %}
             <li><a class="editflair">flair</a></li>
           {% endif %}
           {% if post.uid == current_user.uid %}
             <li><a class="edit-post" data-pid="{{post.pid}}">edit</a></li>
           {% endif %}
           {% if post.uid == current_user.uid or current_user.is_admin() or current_user.is_mod(post.sid) %}
             <li><a class="delete-post"> delete </a></li>
           {%endif%}
           {% if not sub.nsfw and (post.uid == current_user.uid or current_user.is_admin() or current_user.is_mod(post.sid)) %}
            {% if not post.nsfw %}
             <li><a class="nsfw-post"> tag as nsfw </a></li>
            {% else %}
             <li><a class="nsfw-post"> remove nsfw </a></li>
            {% endif %}
           {%endif%}
           <!-- Note from past self: DO NOT REMOVE THIS UNLESS YOU'VE FINISHED UNFUCKING THE JS -->
           <form id="delete-post-form" class="hide">{{delpostform.csrf_token}}{{delpostform.post(value=post.pid)}}</form>
           {% if current_user.is_mod(post.sid) %}
             {% if post.pid in func.getStickyPid(post['sid']) %}
               <li><a class="stick-post">unstick</a></li>
             {% else %}
               <li><a class="stick-post">make sticky</a></li>
             {% endif %}
           {%endif%}
         {%endif%}
       </ul>

    </div>
  </div>
  {% if (func.userCanFlair(func.getSub(post.sid)) and current_user.uid == post.uid) or current_user.is_mod(post.sid) %}
    <div style="display:none;" id="postflairs">
      <span class="closemsg">×</span>
      {% if func.getPostFlair(post) %}
      <div>Current flair: <span class="postflair">{{func.getPostFlair(post)}}</span>. <a id="remove-flair">Remove</a>.</div>
      {%endif%}
      <h4>Select a new flair</h4>
      {% for ll in editpostflair.flair %}
        <span class="selflair" data-sub="{{post.sub}}" data-flair="{{ll.data}}" data-pid="{{post.pid}}">{{ll.label}}</span>
      {% endfor %}
    </div>
  {%endif %}
   {% if post.content %}
   {% if not post.deleted %}
     <div id="postcontent">
       {{markdown(post.content)|safe}}
     </div>
     <div id="post-source">{{post.content}}</div>
   {%else%}
    <div class="deleted">[deleted]</div>
   {%endif%}
   {%endif%}

   {%if current_user.is_authenticated %}
     <form data-reset="true" data-reload='true' action="{{url_for('do.create_comment', sub=sub.name, pid=post.pid)}}" class="comment-form ajaxform static pure-form">
       {{commentform.csrf_token}}
       {{commentform.post(value=post.pid)}}
       {{commentform.parent(value='0')}}
       <div class="markdown-editor" id="ncme">
         {{commentform.comment(id="comment2", placeholder="Write your comment here. Styling with Markdown format is supported.", rows="6")}}
       </div>
       <div class="error alertbox"></div>
       <button type="submit" class="pure-button pure-button-primary">Submit comment</button>
       <button data-pvid="ncme" class="pure-button btn-preview">Preview</button>
       <div class="cmpreview canclose" style="display:none;">
         <h4>Comment preview</h4>
         <span class="closemsg">×</span>
         <div class="cpreview-content"></div>
       </div>
     </form>
   {%endif%}

   {% if comments|length == 0 %}
    <div class="comments"><h3>No comments yet...</h3></div>
   {%else%}
    <div class="comments">
      <h3>{{comments|length}} comments</h3>
      {% include "postcomments.html" %}
    </div>
   {%endif%}
</div>

{% endblock %}
{%block pagefoot%}
{% if not current_user.block_styles() %}
<style>{{db.get_sub_stylesheet(post.sid)|safe}}</style>
{% endif %}
{%endblock%}
