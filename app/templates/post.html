{% extends "layout.html" %}
{% block title %}{{post.title}} | {{config.LEMA}}{% endblock %}

{% block navbar %}
<li>
  <a href="{{url_for('view_sub', sub=func.getSub(post.sid).name)}}">
    {% if func.isNSFW(func.getSub(post.sid)) %}
      <span class="bgred" alt="Not safe for work">NSFW</span>
    {% endif %}
    {{func.getSub(post.sid).name}}
  </a>
</li>
<li><a href="{{url_for('view_sub_hot', sub=func.getSub(post.sid).name)}}">Hot</a></li>
<li><a href="{{url_for('view_sub_top', sub=func.getSub(post.sid).name)}}">Top</a></li>
<li><a href="{{url_for('view_sub_new', sub=func.getSub(post.sid).name)}}">New</a></li>
{% endblock %}
{% block sidebar %}
{{ super() }}<hr/>
<div class="sidebar col-12">
  <p>
    <span class="time">
      <i class="fa fa-clock-o" aria-hidden="true"></i> Posted <time-ago datetime="{{post.posted.isoformat()}}Z"></time-ago>
    </span>
  </p>
  {% if post.edited == true %}
  <p>
    <span class="time">
      <i class="fa fa-clock-o" aria-hidden="true"></i> Last edited <time-ago datetime="{{post.posted.isoformat()}}Z"></time-ago>
    </span>
  </p>
  {% endif %}
  <!--<p>xx views</p>-->
  <p>{{func.get_post_upcount(post.pid)}} upvoted, {{func.get_post_downcount(post.pid)}} downvoted</p>

</div>

<span class="col-12"><hr><span>
<div class="row buttons">
  <div class="sidebar col-12">
    {% if current_user.has_subscribed(post.sid) %}
    <span id="subscribe" class="subscribed" data-sid="{{func.getSub(post.sid).sid}}"><a class="btn small"><i class="fa fa-check" aria-hidden="true"></i> Subscribed</a></span>
    {% else %}
    <span id="subscribe" class="unsubscribed" data-sid="{{func.getSub(post.sid).sid}}"><a class="btn small"><i class="fa fa-plus" aria-hidden="true"></i> Subscribe</a></span>
    {% endif %}
    {% if current_user.has_blocked(post.sid) %}
    <span id="block" class="blocked" data-sid="{{func.getSub(post.sid).sid}}"><a class="btn small"><i class="fa fa-check" aria-hidden="true"></i> Blocked</a></span>
    {% else %}
    <span id="block" class="unblocked" data-sid="{{func.getSub(post.sid).sid}}"><a class="btn small"><i class="fa fa-remove" aria-hidden="true"></i> Block</a></span>
    {% endif %}
  </div>
  <div class="subscribercount col-12">
    <i class="fa fa-users" aria-hidden="true"></i> {{getSuscriberCount(func.getSub(post.sid))}} Subscribers
  </div>
  <span class="col-12"><hr><span>
    {% if func.isRestricted(func.getSub(post.sid)) %}
    <div class="col-12">
      Only mods can post.
    </div>
    {% endif %}
    {% if not func.isRestricted(func.getSub(post.sid)) or (current_user.is_mod(func.getSub(post.sid)) and func.isRestricted(func.getSub(post.sid))) %}
    <div class="col-12">
      <a href="{{url_for('submit_text', sub=func.getSub(post.sid).name)}}" class="btn btn-orange create-post" style="width:100%;">Submit a text post</a>
    </div>
    <div class="col-12">
      <a href="{{url_for('submit_link', sub=func.getSub(post.sid).name)}}" class="btn btn-orange create-post" style="width:100%;">Submit a link post</a>
    </div>
    {% endif %}

  {% if current_user.is_subban(func.getSub(post.sid)) %}
  <div class="col-12">
    You are currently banned from posting.
  </div>
  {% endif %}
</div>
{{markdown(func.getSub(post.sid).sidebar)|safe}}

<span class="col-12"><hr><span>
<p class="createdby">Created by {% if func.getSubUsers(func.getSub(post.sid), 'mod') == '[Deleted]' %} Pkuks {% else %} {{func.getSubUsers(func.getSub(post.sid), 'mod')}} {% endif %}
  <time-ago datetime="{{func.getSubCreation(func.getSub(post.sid))}}Z"></time-ago>
</p>
<div class="moderators col-12">
  Moderators
  <ul>
  <li><i class="fa fa-star" title="Owner"></i> <a href="{{url_for('view_user', user=func.getSubUsers(func.getSub(post.sid), 'mod1'))}}">{{func.getSubUsers(func.getSub(post.sid), 'mod1')}}</a></li>
  {% for mod in mods %}
  <li><a href="{{url_for('view_user', user=db.get_user_from_uid(mod.value).name)}}">{{db.get_user_from_uid(mod.value).name}}</a></li>
  {% endfor %}
  </ul>
</div>
{% if current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
<div class="row buttons">
  <div class="col-12">
    <a href="{{url_for('edit_sub', sub=func.getSub(post.sid).name)}}" class="btn btn-orange edit-sub" style="width:100%;">Edit Sub Info</a>
  </div>
  <div class="col-12">
    <a href="{{url_for('edit_sub_flairs', sub=func.getSub(post.sid).name)}}" class="btn btn-orange edit-sub" style="width:100%;">Edit Sub Flairs</a>
  </div>
  <div class="col-12">
    <a href="{{url_for('edit_sub_css', sub=func.getSub(post.sid).name)}}" class="btn btn-orange edit-sub" style="width:100%;">Edit Sub Stylesheet</a>
  </div>
  <div class="col-12">
    <a href="{{url_for('edit_sub_mods', sub=func.getSub(post.sid).name)}}" class="btn btn-orange edit-sub" style="width:100%;">Moderators</a>
  </div>
</div>
{% endif %}
<span class="col-12"><hr><span>

<div class="row buttons">
  <div class="col-12">
    <a href="{{url_for('view_sublog', sub=func.getSub(post.sid).name)}}" class="btn btn-orange edit-sub" style="width:100%;">Sub Log</a>
  </div>
  <div class="col-12">
    <a href="{{url_for('view_sub_bans', sub=func.getSub(post.sid).name)}}" class="btn btn-orange edit-sub" style="width:100%;">Banned Users</a>
  </div>
</div>

{% endblock %}

{% block main %}
    <main class="center">
        <article class="text-post center no-padding">
          <div class="head" data-pid="{{post.pid}}">
            <div class="pull left vote" style="margin-right: 10px;">
              {% if not db.is_post_deleted(post) %}
                <form class="uvform">
                  <div class="upvote{%if func.getVoteStatus(current_user.get_id(), post.pid) == 1%} upvoted{%endif%}"><i class="fa fa-chevron-up" aria-hidden="true"></i></div>
                  {% set uv = form.VoteForm() %}
                  {{uv.csrf_token}}{{uv.post(value=post.pid)}}
                </form>
                <p class="count">{{post['score']}}</p>
                <form class="dvform">
                  <div class="downvote{%if func.getVoteStatus(current_user.get_id(), post.pid) == 0%} downvoted{%endif%}"><i class="fa fa-chevron-down" aria-hidden="true"></i></div>
                  {% set dv = form.VoteForm() %}
                  {{uv.csrf_token}}{{uv.post(value=post.pid)}}
                </form>
              {% endif %}
            </div>
            {% if func.getPostFlair(post) %}<span class="btn">{{func.getPostFlair(post)}}</span>{% endif %}
            {% if db.is_post_nsfw(post) %}<span class="bgred" alt="Not safe for work">NSFW</span>{% endif %}
            <h1 class="title"><a href="{%if post.ptype== 0 %}{{url_for('view_post', sub=sub.name, pid=post.pid)}}{% else %}{{post.link}}{%endif%}">{{post.title}}</a></h1>
            <div class="info">
            {# if post.ptype == 1 %}
              <p class="modpost"><i class="fa fa-user fa-2x" aria-hidden="true"></i> Mod post</p>
            {% endif #}
              {% if not db.is_post_deleted(post) %}
              <a href="{{url_for('view_user', user=func.getUser(post.uid).name)}}" class="btn small"><i class="fa fa-user" aria-hidden="true"></i> {{func.getUser(post.uid).name}}</a>
              {% else %}
                [Deleted]
              {% endif %}
              {% if current_user.is_authenticated %}
                {% if db.get_user_saved(current_user.uid, post.pid) %}
                  <a class="removesavedpost btn small" data-pid="{{post.pid}}"><i class="fa fa-save" aria-hidden="true"></i> unsave</a>
                {% else %}
                  <a class="savepost btn small" data-pid="{{post.pid}}"><i class="fa fa-save" aria-hidden="true"></i> save</a>
                {% endif %}
              {% endif %}
            {% if func.getUser(post.uid).uid == session['user_id'] or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
              {% if func.userCanFlair(func.getSub(post.sid)) or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
                <a href="#edit-flair-form" class="btn btn-orange edit small edit-flair-form" aria-hidden="true"><i class="fa fa-flag"></i> Flair</a>
              {% endif %}
              {% if func.getUser(post.uid).uid == session['user_id'] or current_user.is_admin() %}
                {% if post.ptype == 0 %}
                <a href="#edit-txtpost-form" class="btn btn-orange edit small edit-txtpost-form"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit </a>
                {% else %}
                <a href="#edit-linkpost-form" class="btn btn-orange edit small edit-linkpost-form"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit </a>
                {% endif %}
              {% endif %}
              {% if not db.is_post_deleted(post) %}
              <a href="#delete-post-form" data-post="{{post.pid}}" class="btn btn-orange edit small btn-red delete-post-form"><i class="fa fa-trash" aria-hidden="true"></i> Delete </a>
              {% else %}
              [Deleted]
              {% endif %}
              {% set ann = func.getAnnouncement() %}
              {% if current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
                {% if post in func.getStickies(post['sid']) %}
                  <a href="#make_sticky-form" class="pull right btn btn-orange small make_announcement-form"><i class="fa fa-thumb-tack" aria-hidden="true"></i> Unstick</a>
                {% else %}
                  <a href="#make_sticky-form" class="pull right btn btn-orange small make_announcement-form"><i class="fa fa-thumb-tack" aria-hidden="true"></i> Make sticky</a>
                {% endif %}
              {%endif%}
              {% if func.getSub(post.sid).name == "announcements" and current_user.is_admin() and ann.pid != post.pid %}
                <a href="#make_announcement-form" class="pull right btn btn-orange small make_announcement-form"><i class="fa fa-cube" aria-hidden="true"></i> Make announcement</a>
              {%endif %}
              {% if ann.pid == post.pid %}
                <div class="pull right btn btn-purple small disabled">Announcement</div>
              {% endif %}
            {% endif %}
            </div>
          </div>
          {% if post.ptype == 0 %}
          <div class="content">{{markdown(post.content)|safe}}</div>
          {% else %}
          {% if post.link.startswith('http:') %}<span><i title="not https" class="fa fa-exclamation-circle orange"></i></span>{% endif %}
          <div class="content">
          {% if func.isImage(post.link) %}
            <span id="openimg" data-img="{{post.link}}" data-pid="{{post.pid}}" class="closedimg">
              <a href="{{post.link}}" {% if current_user.has_exlinks() %}target="_blank" {% endif %} rel="noreferrer noopener">{{post.link}}</a>
              <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-image" aria-hidden="true"></i></a></span>
            </span>
          {% else %}
            <a href="{{post.link}}" {% if current_user.has_exlinks() %}target="_blank" {% endif %} rel="noreferrer noopener">{{post.link}}</a>
            {% if func.getDomain(post.link) == "youtube.com" or func.getDomain(post.link) == "www.youtube.com" or func.getDomain(post.link) == "youtu.be" %}
              <span id="youtubevid" data-vid="{{post.link}}" data-pid="{{post.pid}}" class="closedvid">
                <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-youtube-play" aria-hidden="true"></i></a></span>
              </span>
            {% elif func.getDomain(post.link) == "vimeo.com" %}
              <span id="vimeovid" data-vid="{{post.link}}" data-pid="{{post.pid}}" class="closedvid">
                <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-vimeo" aria-hidden="true"></i></a></span>
              </span>
            {% elif func.getDomain(post.link) == "vine.co" %}
              <span id="vinevid" data-vid="{{post.link}}" data-pid="{{post.pid}}" class="closedvine">
                <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-vine" aria-hidden="true"></i></a></span>
              </span>
            {% elif func.getDomain(post.link) == "gfycat.com" %}
              <span id="gfycat" data-vid="{{post.link}}" data-pid="{{post.pid}}" class="closedgfycat">
                <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-video-camera" aria-hidden="true"></i></a></span>
              </span>
            {% elif func.isVideo(post.link) %}
            <span id="openvideo" data-vid="{{post.link}}" data-pid="{{post.pid}}" data-domain="{{func.getDomain(post.link)}}" class="closedvid">
              <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-play" aria-hidden="true"></i></a></span>
            </span>
            {% elif func.isGifv(post.link) %}
            <span id="gifv" data-vid="{{post.link}}" data-pid="{{post.pid}}" data-domain="{{func.getDomain(post.link)}}" class="closedgifv">
              <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-play" aria-hidden="true"></i></a></span>
            </span>
            {% elif func.getDomain(post.link) == "twitter.com" %}
              <span id="tweet" data-url="{{post.link}}" data-pid="{{post.pid}}" class="closedtweet">
                <span id="player{{post.pid}}"><a class="btn small"><i class="fa fa-twitter" aria-hidden="true"></i></a></span>
              </span>
            {% endif %}
          {% endif %}
          </div>
          {% endif %}
        </article>
        <hr>
        {%if current_user.is_authenticated %}
        <section id="postcomment">
          <form data-reset="true" data-reload='true' action="{{url_for('do.create_comment', sub=func.getSub(post.sid).name, pid=post.pid)}}" class="comment-form ajaxform static">
            {{commentform.csrf_token}}
            {{commentform.sub(value=func.getSub(post.sid).name)}}
            {{commentform.post(value=post.pid)}}
            {{commentform.parent(value='0')}}
            <div class="CommentContent">{{commentform.comment(id="comment2", placeholder="Write your comment here. Styling with Markdown format is supported.", rows="10", **{'data-provide' :"markdown"})}}</div>
            <div class="alert div-error"></div>
            <button type="submit" class="btn btn-orange">Submit comment</button>
          </form>
          <form data-reset="true" data-reload='true'  method="POST" action="{{url_for('do.create_comment', sub=func.getSub(post.sid).name, pid=post.pid)}}" class="ajaxform comment-form moving" style="display:none">
            <span class="close">×</span>
            {{commentform.csrf_token}}
            {{commentform.sub(value=func.getSub(post.sid).name)}}
            {{commentform.post(value=post.pid)}}
            {{commentform.parent(value='0')}}
            <div class="CommentContent">{{commentform.comment(class="commenttxtbox",placeholder="Write your comment here. Styling with Markdown format is supported.", rows="10")}}</div>
            <div class="alert div-error"></div>
            <button type="submit" class="btn btn-orange">Submit comment</button>
          </form>
        </section>
        {%endif%}
        <section id="comments">
          <h1><a href="{{url_for('view_post', sub=sub.name, pid=post.pid)}}">Comments</a> ({{db.get_post_comment_count(post.pid)}})</h1>
          {% if comments|length < 1 %}
          <p>
            Be the first to comment this post
          </p>
          {% endif %}
          {% include "postcomments.html" %}
        </section>
    </main>

  {% if post.ptype == 1 and func.getUser(post.uid).uid == session['user_id'] or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
  <form id="edit-linkpost-form" data-sub="{{func.getSub(post.sid).name}}" data-pid="{{post.pid}}" class="mfp-hide white-popup-block">
    {{editlinkpostform.csrf_token}}
    <h1>Edit your link post</h1>
    <p><label>{{editlinkpostform.nsfw.label.text}} {{editlinkpostform.nsfw(checked=db.is_post_nsfw(post))}}</label></p>
    <div class="alert div-error">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <p></p>
    </div>
    <p><button type="submit" class="btn btn-blue" id="edit-linkpost-btnsubmit">Edit post</button></p>
  </form>
  {% endif %}
  {% if post.ptype == 0 and func.getUser(post.uid).uid == session['user_id'] or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
  <form id="edit-txtpost-form" data-sub="{{func.getSub(post.sid).name}}" data-pid="{{post.pid}}" class="mfp-hide white-popup-block">
    {{edittxtpostform.csrf_token}}
    <h1>Edit your text post</h1>
    <p><label>{{edittxtpostform.nsfw.label.text}} {{edittxtpostform.nsfw(checked=db.is_post_nsfw(post))}}</label></p>
    <p class="content" style="text-align: left;">{{edittxtpostform.content(rows="10", **{'data-provide' :"markdown"})}}</p>
    <div class="alert div-error">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <p></p>
    </div>
    <p><button type="submit" class="btn btn-blue" id="edit-txpost-btnsubmit">Edit post</button></p>
  </form>
  {% endif %}
  {% if current_user.is_authenticated %}
    <form action="{{url_for('do.edit_comment')}}" data-reload="true" id="edit-comment-form"  method="POST" class="ajaxform mfp-hide white-popup-block">
      <h2>Edit comment</h2>
      {% set cf = form.EditCommentForm() %}
      {{cf.csrf_token}}{{cf.cid(id="ecf-cid")}}
      <p>{{cf.text(rows="10", **{'data-provide' :"markdown"})}}</p>
      <p><button type="submit" class="btn btn-blue" data-prog="Saving..">Edit comment</button></p>
    </form>

    <form action="{{url_for('do.delete_comment')}}" data-reload="true" id="delete-comment-form"  method="POST" class="ajaxform mfp-hide white-popup-block">
      <h2>Deleting comment</h2>
      <p>Are you sure you want to do this?</p>
      {% set cf = form.DeleteCommentForm() %}
      {{cf.csrf_token}}{{cf.cid(id="dcf-cid")}}
      <p><button type="submit" class="btn btn-blue" data-prog="Deleting..">Yup!</button></p>
    </form>
  {%endif%}
  {% if func.getUser(post.uid).uid == session['user_id'] or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
  <form id="delete-post-form" class="mfp-hide white-popup-block">
    {{delpostform.csrf_token}}
    {{delpostform.post(value=post.pid)}}
    <h3>Are you sure you want to delete this post?</h3>
    <div class="alert div-error">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <p></p>
    </div>
    <p><button type="submit" class="btn btn-blue" id="delpost-btnsubmit">Delete!</button></p>
  </form>
  {% endif %}
  {% if func.getSub(post.sid).name == "announcements" and current_user.is_admin() and ann.pid != post.pid %}
  <form id="make_announcement-form" class="mfp-hide white-popup-block" action="{{url_for('do.make_announcement')}}" method="POST">
    {{delpostform.csrf_token}}
    {{delpostform.post(value=post.pid)}}
    <h3>Are you sure you want to announce this??</h3>
    <div class="alert div-error">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <p></p>
    </div>
    <p><button type="submit" class="btn btn-blue" id="make_announcement-btnsubmit">Yup!</button></p>
  </form>
  {%endif%}
  {% if current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
  <form id="make_sticky-form" class="mfp-hide white-popup-block" action="{{url_for('do.toggle_sticky', post=post.pid)}}" method="POST">
    {{delpostform.csrf_token}}
    {{delpostform.post(value=post.pid)}}
    <h3>Are you sure you want to {% if post in func.getStickies(post['sid']) %}un{%endif%}stick this?</h3>
    <div class="alert div-error">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
      <p></p>
    </div>
    <p><button type="submit" class="btn btn-blue" id="make_announcement-btnsubmit">Yup!</button></p>
  </form>
  {%endif%}
  {% if func.getUser(post.uid).uid == session['user_id'] or current_user.is_mod(func.getSub(post.sid)) or current_user.is_admin() %}
  <form id="edit-flair-form" class="mfp-hide white-popup-block ajaxform" action="" method="POST">
    {{editpostflair.csrf_token}}
    {{editpostflair.post(value=post.pid)}}
    {% if func.getPostFlair(post) %}
    <h3>Current flair</h3>
    <p><div class="btn">{{func.getPostFlair(post)}}</div></p>
    <p><div class="btn btn-blue" id="removepostflair" data-sub="{{func.getSub(post.sid).name}}" data-post="{{post.pid}}"><i class="fa fa-remove"></i> Remove current flair</div></p>

    {% endif %}
    <h3>Avalable post flairs</h3>
    <div class="btn-group" data-toggle="buttons">
      {% for ll in editpostflair.flair %}
        <label class="btn btn-default assignpostflair" data-fl="{{ll.data}}" data-sub="{{func.getSub(post.sid).name}}" data-post="{{post.pid}}">
          {{ll}}
          {{ll.label}}</label>
      {%endfor %}
    </div>

  </form>
  {% endif %}

{% endblock %}
{%block pagefoot%}
{% if not current_user.block_styles() %}
<style>{{db.get_sub_stylesheet(post.sid)|safe}}</style>
{% endif %}
{%endblock%}
